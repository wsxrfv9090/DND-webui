# DND-webui 项目全栈开发说明文档

## 一、项目理念与目标

本项目旨在实现一个基于DND规则的AI驱动TRPG（桌面角色扮演游戏）Demo。AI作为“裁判”和“叙述者”，玩家通过Web页面与AI互动，体验自动生成的冒险故事。

核心理念：

- 规则判定、状态管理由代码完成，AI只负责描述和氛围渲染。

- 世界观、地图、节点、技能等数据结构化，便于扩展和维护。

------

## 二、系统架构与分工

### 1. 前端（Next.js/React）

- 负责用户输入（如对话、行动指令）的采集与展示。

- 通过 HTTP API 与后端交互，获取AI生成的故事描述和判定结果。

- 展示AI返回的文本、骰点结果、技能判定等信息。

### 2. 后端（FastAPI + Python）

- 提供API接口，接收前端请求，返回AI生成的内容。

- 负责AI判定、技能判定、骰点、世界观描述等核心逻辑。

- 维护技能数据（skills.json）等结构化信息。

### 3. AI服务（Kimi/Moonshot）

- 第一个AI：负责判定用户输入是否需要技能判定、判定用什么技能、难度是多少。

- 第二个AI：根据用户输入和判定结果，生成世界观下的故事描述。

------

## 三、核心数据流与逻辑流程

### 1. 用户输入

- 用户在前端输入一句话（如“我想说服守卫放我进去”）。

### 2. 判定AI分析

- 后端调用 analyze_action(user_input)，AI返回结构化结果：

- 需要判定：True/False

- 技能名称（如“说服”）

- 难度（0=普通，1=困难，2=极难）

### 3. 技能判定（如需要）

- 后端查找技能成功率（skills.json）。

- 投骰（1d100），与技能成功率和难度比较，判定成功/失败。

- 生成结构化判定描述（如“你尝试进行说服判定，骰点结果为47，通过。”）

### 4. 叙述AI生成故事

- 后端调用 generate_description(user_input, judge_result)，AI根据用户原话和判定结果生成世界观下的故事描述。

- 如果不需要判定，则直接用用户原话生成描述。

### 5. 前端展示

- 前端收到后端返回的故事描述、判定结果等，展示给用户。

------

## 四、主要接口说明

### 1. FastAPI 后端接口

- POST /process-text

- 请求体：{"user_input": "用户输入的一句话"}

- 返回：{"output": "AI生成的故事描述"}

### 2. 后端核心逻辑（main.py）

- 读取 skills.json

- 调用 ai/test_ai.py 的 analyze_action、get_skill_success_rate、judge、describe_action、generate_description 等函数

- 组织数据流，返回最终描述

### 3. ai/test_ai.py 主要函数

- analyze_action(user_input)

AI判定是否需要技能判定、用什么技能、难度是多少

- get_skill_success_rate(skill_name, skills_list)

查找技能成功率

- judge(roll_result, success_rate, difficulty)

判定是否通过

- describe_action(user_input, skill_name, difficulty, roll_result, success)

生成结构化判定描述

- generate_description(user_input, judge_result=None)

AI生成世界观下的故事描述

------

## 五、数据结构

- skills.json

存储所有技能及其基础成功率，便于后端查找和维护。



------

## 六、开发与联调建议

- 前端可用 Postman 或 curl 测试后端API，确保接口通畅。

- 后端可用 print/log 输出调试AI判定和描述结果。

- 技能、难度等数据如需调整，直接修改 skills.json 即可。

- 若需扩展AI能力，只需调整 ai/test_ai.py 的 prompt 或模型调用方式。

------

如有任何问题，欢迎随时沟通！